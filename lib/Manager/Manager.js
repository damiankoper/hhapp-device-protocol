"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const socket_io_1 = __importDefault(require("socket.io"));
const DeviceManaged_1 = __importDefault(require("./DeviceManaged"));
class Manager {
    constructor(config) {
        this.devices = [];
        this.statusHandlers = new Map();
        this.proxySettings = [];
        this.config = config;
        this.socket = socket_io_1.default();
        this.socket.listen(this.config.port);
        this.socket.on('connection', socket => {
            this.initConnectedDevice(socket);
        });
    }
    destroy() {
        this.socket.close();
    }
    getDevices() {
        return this.devices;
    }
    onConnection(fn) {
        this.onConnectionHandler = fn;
    }
    onStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.onStatus(fn);
        });
        this.statusHandlers.set(fn, target);
    }
    offStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.offStatus(fn);
        });
        this.statusHandlers.delete(fn);
    }
    sendAction(actionConfig, payload) {
        const target = this.findTargets(actionConfig);
        if (target.length === 0) {
            throw new Error('Action ' + actionConfig.action + ' target not found!');
        }
        target.forEach((d) => {
            d.sendAction(actionConfig.action, payload);
        });
    }
    proxy(config) {
        this.proxySettings.push(config);
        const found = this.findTargets(config);
        found.forEach(device => {
            device.addProxy(config.servers);
        });
    }
    findTargets(targetConfig) {
        return this.devices.filter(d => d.matchesTarget(targetConfig));
    }
    initConnectedDevice(socket) {
        const device = new DeviceManaged_1.default(Object.assign({}, socket.handshake.query, { socket }));
        this.devices.push(device);
        this.setStatusHandlers(device);
        this.setProxies(device);
        socket.on('disconnect', () => this.destroyDisconnectedDevice(socket));
        if (this.onConnectionHandler) {
            this.onConnectionHandler(device);
        }
    }
    setProxies(device) {
        this.proxySettings.forEach(config => {
            if (device.matchesTarget(config)) {
                device.addProxy(config.servers);
            }
        });
    }
    setStatusHandlers(device) {
        this.statusHandlers.forEach((target, fn) => {
            if (device.matchesTarget(target)) {
                device.onStatus(fn);
            }
        });
    }
    destroyDisconnectedDevice(socket) {
        const found = this.devices.findIndex(d => d.getSocket() === socket);
        this.devices.splice(found, 1);
    }
}
exports.Manager = Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9NYW5hZ2VyL01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBaUM7QUFJakMsb0VBQTRDO0FBdUI1QyxNQUFhLE9BQU87SUFZbEIsWUFBWSxNQUFxQjtRQVR6QixZQUFPLEdBQW9CLEVBQUUsQ0FBQztRQUU5QixtQkFBYyxHQUdsQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ04sa0JBQWEsR0FBd0IsRUFBRSxDQUFDO1FBSTlDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsbUJBQVEsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxPQUFPO1FBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRU0sVUFBVTtRQUNmLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBRU0sWUFBWSxDQUFDLEVBQW1DO1FBQ3JELElBQUksQ0FBQyxtQkFBbUIsR0FBRyxFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVNLFFBQVEsQ0FBQyxNQUFvQixFQUFFLEVBQWtDO1FBQ3RFLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEIsQ0FBQyxDQUFDLENBQUM7UUFD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QUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8seUJBQXlCLENBQUMsTUFBdUI7UUFDdkQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLEtBQUssTUFBTSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDRjtBQXpHRCwwQkF5R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU29ja2V0SU8gZnJvbSAnc29ja2V0LmlvJztcblxuaW1wb3J0IHsgRGV2aWNlU2VydmVyQ29uZmlnIH0gZnJvbSAnLi4vRGV2aWNlL0RldmljZSc7XG5pbXBvcnQgeyBEZXZpY2VTdGF0dXMgfSBmcm9tICcuLi9EZXZpY2UvU3RhdHVzJztcbmltcG9ydCBEZXZpY2VNYW5hZ2VkIGZyb20gJy4vRGV2aWNlTWFuYWdlZCc7XG5cbnR5cGUgTWFjQWRkcmVzcyA9IHN0cmluZztcbnR5cGUgRGV2aWNlVHlwZSA9IHN0cmluZztcbnR5cGUgQWN0aW9uVHlwZSA9IHN0cmluZztcblxuZXhwb3J0IGludGVyZmFjZSBNYW5hZ2VyQ29uZmlnIHtcbiAgcG9ydDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhcmdldENvbmZpZyB7XG4gIG5hbWU/OiBNYWNBZGRyZXNzO1xuICB0eXBlPzogRGV2aWNlVHlwZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBY3Rpb25Db25maWcgZXh0ZW5kcyBUYXJnZXRDb25maWcge1xuICBhY3Rpb246IEFjdGlvblR5cGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGV2aWNlUHJveHlDb25maWcgZXh0ZW5kcyBUYXJnZXRDb25maWcge1xuICBzZXJ2ZXJzOiBEZXZpY2VTZXJ2ZXJDb25maWdbXTtcbn1cblxuZXhwb3J0IGNsYXNzIE1hbmFnZXIge1xuICBwcml2YXRlIGNvbmZpZzogTWFuYWdlckNvbmZpZztcbiAgcHJpdmF0ZSBzb2NrZXQ6IFNvY2tldElPLlNlcnZlcjtcbiAgcHJpdmF0ZSBkZXZpY2VzOiBEZXZpY2VNYW5hZ2VkW10gPSBbXTtcblxuICBwcml2YXRlIHN0YXR1c0hhbmRsZXJzOiBNYXA8XG4gICAgKHN0YXR1czogRGV2aWNlU3RhdHVzKSA9PiB2b2lkLFxuICAgIFRhcmdldENvbmZpZ1xuICA+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHByb3h5U2V0dGluZ3M6IERldmljZVByb3h5Q29uZmlnW10gPSBbXTtcbiAgcHJpdmF0ZSBvbkNvbm5lY3Rpb25IYW5kbGVyPzogKGRldmljZTogRGV2aWNlTWFuYWdlZCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IE1hbmFnZXJDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLnNvY2tldCA9IFNvY2tldElPKCk7XG4gICAgdGhpcy5zb2NrZXQubGlzdGVuKHRoaXMuY29uZmlnLnBvcnQpO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdjb25uZWN0aW9uJywgc29ja2V0ID0+IHtcbiAgICAgIHRoaXMuaW5pdENvbm5lY3RlZERldmljZShzb2NrZXQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zb2NrZXQuY2xvc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXREZXZpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLmRldmljZXM7XG4gIH1cblxuICBwdWJsaWMgb25Db25uZWN0aW9uKGZuOiAoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5vbkNvbm5lY3Rpb25IYW5kbGVyID0gZm47XG4gIH1cblxuICBwdWJsaWMgb25TdGF0dXModGFyZ2V0OiBUYXJnZXRDb25maWcsIGZuOiAoc3RhdHVzOiBEZXZpY2VTdGF0dXMpID0+IHZvaWQpIHtcbiAgICB0aGlzLmZpbmRUYXJnZXRzKHRhcmdldCkuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLm9uU3RhdHVzKGZuKTtcbiAgICB9KTtcbiAgICB0aGlzLnN0YXR1c0hhbmRsZXJzLnNldChmbiwgdGFyZ2V0KTtcbiAgfVxuXG4gIHB1YmxpYyBvZmZTdGF0dXModGFyZ2V0OiBUYXJnZXRDb25maWcsIGZuOiAoc3RhdHVzOiBEZXZpY2VTdGF0dXMpID0+IHZvaWQpIHtcbiAgICB0aGlzLmZpbmRUYXJnZXRzKHRhcmdldCkuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLm9mZlN0YXR1cyhmbik7XG4gICAgfSk7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVycy5kZWxldGUoZm4pO1xuICB9XG5cbiAgcHVibGljIHNlbmRBY3Rpb24oYWN0aW9uQ29uZmlnOiBBY3Rpb25Db25maWcsIHBheWxvYWQ6IG9iamVjdCkge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZmluZFRhcmdldHMoYWN0aW9uQ29uZmlnKTtcbiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBY3Rpb24gJyArIGFjdGlvbkNvbmZpZy5hY3Rpb24gKyAnIHRhcmdldCBub3QgZm91bmQhJyk7XG4gICAgfVxuICAgIHRhcmdldC5mb3JFYWNoKChkOiBEZXZpY2VNYW5hZ2VkKSA9PiB7XG4gICAgICBkLnNlbmRBY3Rpb24oYWN0aW9uQ29uZmlnLmFjdGlvbiwgcGF5bG9hZCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcHJveHkoY29uZmlnOiBEZXZpY2VQcm94eUNvbmZpZykge1xuICAgIHRoaXMucHJveHlTZXR0aW5ncy5wdXNoKGNvbmZpZyk7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLmZpbmRUYXJnZXRzKGNvbmZpZyk7XG4gICAgZm91bmQuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLmFkZFByb3h5KGNvbmZpZy5zZXJ2ZXJzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFRhcmdldHModGFyZ2V0Q29uZmlnOiBUYXJnZXRDb25maWcpOiBEZXZpY2VNYW5hZ2VkW10ge1xuICAgIHJldHVybiB0aGlzLmRldmljZXMuZmlsdGVyKGQgPT4gZC5tYXRjaGVzVGFyZ2V0KHRhcmdldENvbmZpZykpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Q29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZGV2aWNlID0gbmV3IERldmljZU1hbmFnZWQoe1xuICAgICAgLi4uc29ja2V0LmhhbmRzaGFrZS5xdWVyeSxcbiAgICAgIHNvY2tldCxcbiAgICB9KTtcbiAgICB0aGlzLmRldmljZXMucHVzaChkZXZpY2UpO1xuICAgIHRoaXMuc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlKTtcbiAgICB0aGlzLnNldFByb3hpZXMoZGV2aWNlKTtcblxuICAgIHNvY2tldC5vbignZGlzY29ubmVjdCcsICgpID0+IHRoaXMuZGVzdHJveURpc2Nvbm5lY3RlZERldmljZShzb2NrZXQpKTtcblxuICAgIGlmICh0aGlzLm9uQ29ubmVjdGlvbkhhbmRsZXIpIHtcbiAgICAgIHRoaXMub25Db25uZWN0aW9uSGFuZGxlcihkZXZpY2UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJveGllcyhkZXZpY2U6IERldmljZU1hbmFnZWQpIHtcbiAgICB0aGlzLnByb3h5U2V0dGluZ3MuZm9yRWFjaChjb25maWcgPT4ge1xuICAgICAgaWYgKGRldmljZS5tYXRjaGVzVGFyZ2V0KGNvbmZpZykpIHtcbiAgICAgICAgZGV2aWNlLmFkZFByb3h5KGNvbmZpZy5zZXJ2ZXJzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSB7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVycy5mb3JFYWNoKCh0YXJnZXQsIGZuKSA9PiB7XG4gICAgICBpZiAoZGV2aWNlLm1hdGNoZXNUYXJnZXQodGFyZ2V0KSkge1xuICAgICAgICBkZXZpY2Uub25TdGF0dXMoZm4pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95RGlzY29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLmRldmljZXMuZmluZEluZGV4KGQgPT4gZC5nZXRTb2NrZXQoKSA9PT0gc29ja2V0KTtcbiAgICB0aGlzLmRldmljZXMuc3BsaWNlKGZvdW5kLCAxKTtcbiAgfVxufVxuIl19