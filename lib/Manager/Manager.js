"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const socket_io_1 = __importDefault(require("socket.io"));
const DeviceManaged_1 = __importDefault(require("./DeviceManaged"));
class Manager {
    constructor(config) {
        this.devices = [];
        this.statusHandlers = new Map();
        this.proxySettings = [];
        this.config = config;
        this.socket = socket_io_1.default();
        this.socket.listen(this.config.port);
        this.socket.on('connection', socket => {
            this.initConnectedDevice(socket);
        });
    }
    destroy() {
        this.socket.close();
    }
    getDevices() {
        return this.devices;
    }
    onConnection(fn) {
        this.onConnectionHandler = fn;
    }
    onStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.onStatus(fn);
        });
        this.statusHandlers.set(fn, target);
    }
    offStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.offStatus(fn);
        });
        this.statusHandlers.delete(fn);
    }
    sendAction(actionConfig, payload) {
        const target = this.findTargets(actionConfig);
        if (target.length === 0) {
            throw new Error('Action ' + actionConfig.action + ' target not found!');
        }
        target.forEach((d) => {
            d.sendAction(actionConfig.action, payload);
        });
    }
    proxy(config) {
        this.proxySettings.push(config);
        const found = this.findTargets(config);
        found.forEach(device => {
            device.addProxy(config.servers);
        });
    }
    findTargets(targetConfig) {
        return this.devices.filter(d => d.matchesTarget(targetConfig));
    }
    initConnectedDevice(socket) {
        const device = new DeviceManaged_1.default(Object.assign({}, socket.handshake.query, { socket }));
        this.devices.push(device);
        this.setStatusHandlers(device);
        this.setProxies(device);
        socket.on('disconnect', () => this.destroyDisconnectedDevice(socket));
        if (this.onConnectionHandler) {
            this.onConnectionHandler(device);
        }
    }
    setProxies(device) {
        this.proxySettings.forEach(config => {
            if (device.matchesTarget(config)) {
                device.addProxy(config.servers);
            }
        });
    }
    setStatusHandlers(device) {
        this.statusHandlers.forEach((target, fn) => {
            if (device.matchesTarget(target)) {
                device.onStatus(fn);
            }
        });
    }
    destroyDisconnectedDevice(socket) {
        const found = this.devices.findIndex(d => d.getSocket() === socket);
        this.devices.splice(found, 1);
    }
}
exports.default = Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9NYW5hZ2VyL01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBaUM7QUFJakMsb0VBQTRDO0FBdUI1QyxNQUFxQixPQUFPO0lBWTFCLFlBQVksTUFBcUI7UUFUekIsWUFBTyxHQUFvQixFQUFFLENBQUM7UUFFOUIsbUJBQWMsR0FHbEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNOLGtCQUFhLEdBQXdCLEVBQUUsQ0FBQztRQUk5QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFHLG1CQUFRLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVNLFVBQVU7UUFDZixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVNLFlBQVksQ0FBQyxFQUFtQztRQUNyRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFTSxRQUFRLENBQUMsTUFBb0IsRUFBRSxFQUFrQztRQUN0RSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4QyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxDQUFDO1FB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QUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNyQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHlCQUF5QixDQUFDLE1BQXVCO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxLQUFLLE1BQU0sQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoQyxDQUFDO0NBQ0Y7QUF6R0QsMEJBeUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNvY2tldElPIGZyb20gJ3NvY2tldC5pbyc7XG5cbmltcG9ydCB7IERldmljZVNlcnZlckNvbmZpZyB9IGZyb20gJy4uL0RldmljZS9EZXZpY2UnO1xuaW1wb3J0IHsgRGV2aWNlU3RhdHVzIH0gZnJvbSAnLi4vRGV2aWNlL1N0YXR1cyc7XG5pbXBvcnQgRGV2aWNlTWFuYWdlZCBmcm9tICcuL0RldmljZU1hbmFnZWQnO1xuXG50eXBlIE1hY0FkZHJlc3MgPSBzdHJpbmc7XG50eXBlIERldmljZVR5cGUgPSBzdHJpbmc7XG50eXBlIEFjdGlvblR5cGUgPSBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFuYWdlckNvbmZpZyB7XG4gIHBvcnQ6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYXJnZXRDb25maWcge1xuICBuYW1lPzogTWFjQWRkcmVzcztcbiAgdHlwZT86IERldmljZVR5cGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uQ29uZmlnIGV4dGVuZHMgVGFyZ2V0Q29uZmlnIHtcbiAgYWN0aW9uOiBBY3Rpb25UeXBlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERldmljZVByb3h5Q29uZmlnIGV4dGVuZHMgVGFyZ2V0Q29uZmlnIHtcbiAgc2VydmVyczogRGV2aWNlU2VydmVyQ29uZmlnW107XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1hbmFnZXIge1xuICBwcml2YXRlIGNvbmZpZzogTWFuYWdlckNvbmZpZztcbiAgcHJpdmF0ZSBzb2NrZXQ6IFNvY2tldElPLlNlcnZlcjtcbiAgcHJpdmF0ZSBkZXZpY2VzOiBEZXZpY2VNYW5hZ2VkW10gPSBbXTtcblxuICBwcml2YXRlIHN0YXR1c0hhbmRsZXJzOiBNYXA8XG4gICAgKHN0YXR1czogRGV2aWNlU3RhdHVzKSA9PiB2b2lkLFxuICAgIFRhcmdldENvbmZpZ1xuICA+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHByb3h5U2V0dGluZ3M6IERldmljZVByb3h5Q29uZmlnW10gPSBbXTtcbiAgcHJpdmF0ZSBvbkNvbm5lY3Rpb25IYW5kbGVyPzogKGRldmljZTogRGV2aWNlTWFuYWdlZCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IE1hbmFnZXJDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLnNvY2tldCA9IFNvY2tldElPKCk7XG4gICAgdGhpcy5zb2NrZXQubGlzdGVuKHRoaXMuY29uZmlnLnBvcnQpO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdjb25uZWN0aW9uJywgc29ja2V0ID0+IHtcbiAgICAgIHRoaXMuaW5pdENvbm5lY3RlZERldmljZShzb2NrZXQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zb2NrZXQuY2xvc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXREZXZpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLmRldmljZXM7XG4gIH1cblxuICBwdWJsaWMgb25Db25uZWN0aW9uKGZuOiAoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5vbkNvbm5lY3Rpb25IYW5kbGVyID0gZm47XG4gIH1cblxuICBwdWJsaWMgb25TdGF0dXModGFyZ2V0OiBUYXJnZXRDb25maWcsIGZuOiAoc3RhdHVzOiBEZXZpY2VTdGF0dXMpID0+IHZvaWQpIHtcbiAgICB0aGlzLmZpbmRUYXJnZXRzKHRhcmdldCkuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLm9uU3RhdHVzKGZuKTtcbiAgICB9KTtcbiAgICB0aGlzLnN0YXR1c0hhbmRsZXJzLnNldChmbiwgdGFyZ2V0KTtcbiAgfVxuXG4gIHB1YmxpYyBvZmZTdGF0dXModGFyZ2V0OiBUYXJnZXRDb25maWcsIGZuOiAoc3RhdHVzOiBEZXZpY2VTdGF0dXMpID0+IHZvaWQpIHtcbiAgICB0aGlzLmZpbmRUYXJnZXRzKHRhcmdldCkuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLm9mZlN0YXR1cyhmbik7XG4gICAgfSk7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVycy5kZWxldGUoZm4pO1xuICB9XG5cbiAgcHVibGljIHNlbmRBY3Rpb24oYWN0aW9uQ29uZmlnOiBBY3Rpb25Db25maWcsIHBheWxvYWQ6IG9iamVjdCkge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZmluZFRhcmdldHMoYWN0aW9uQ29uZmlnKTtcbiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBY3Rpb24gJyArIGFjdGlvbkNvbmZpZy5hY3Rpb24gKyAnIHRhcmdldCBub3QgZm91bmQhJyk7XG4gICAgfVxuICAgIHRhcmdldC5mb3JFYWNoKChkOiBEZXZpY2VNYW5hZ2VkKSA9PiB7XG4gICAgICBkLnNlbmRBY3Rpb24oYWN0aW9uQ29uZmlnLmFjdGlvbiwgcGF5bG9hZCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcHJveHkoY29uZmlnOiBEZXZpY2VQcm94eUNvbmZpZykge1xuICAgIHRoaXMucHJveHlTZXR0aW5ncy5wdXNoKGNvbmZpZyk7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLmZpbmRUYXJnZXRzKGNvbmZpZyk7XG4gICAgZm91bmQuZm9yRWFjaChkZXZpY2UgPT4ge1xuICAgICAgZGV2aWNlLmFkZFByb3h5KGNvbmZpZy5zZXJ2ZXJzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFRhcmdldHModGFyZ2V0Q29uZmlnOiBUYXJnZXRDb25maWcpOiBEZXZpY2VNYW5hZ2VkW10ge1xuICAgIHJldHVybiB0aGlzLmRldmljZXMuZmlsdGVyKGQgPT4gZC5tYXRjaGVzVGFyZ2V0KHRhcmdldENvbmZpZykpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Q29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZGV2aWNlID0gbmV3IERldmljZU1hbmFnZWQoe1xuICAgICAgLi4uc29ja2V0LmhhbmRzaGFrZS5xdWVyeSxcbiAgICAgIHNvY2tldCxcbiAgICB9KTtcbiAgICB0aGlzLmRldmljZXMucHVzaChkZXZpY2UpO1xuICAgIHRoaXMuc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlKTtcbiAgICB0aGlzLnNldFByb3hpZXMoZGV2aWNlKTtcblxuICAgIHNvY2tldC5vbignZGlzY29ubmVjdCcsICgpID0+IHRoaXMuZGVzdHJveURpc2Nvbm5lY3RlZERldmljZShzb2NrZXQpKTtcblxuICAgIGlmICh0aGlzLm9uQ29ubmVjdGlvbkhhbmRsZXIpIHtcbiAgICAgIHRoaXMub25Db25uZWN0aW9uSGFuZGxlcihkZXZpY2UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJveGllcyhkZXZpY2U6IERldmljZU1hbmFnZWQpIHtcbiAgICB0aGlzLnByb3h5U2V0dGluZ3MuZm9yRWFjaChjb25maWcgPT4ge1xuICAgICAgaWYgKGRldmljZS5tYXRjaGVzVGFyZ2V0KGNvbmZpZykpIHtcbiAgICAgICAgZGV2aWNlLmFkZFByb3h5KGNvbmZpZy5zZXJ2ZXJzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSB7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVycy5mb3JFYWNoKCh0YXJnZXQsIGZuKSA9PiB7XG4gICAgICBpZiAoZGV2aWNlLm1hdGNoZXNUYXJnZXQodGFyZ2V0KSkge1xuICAgICAgICBkZXZpY2Uub25TdGF0dXMoZm4pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95RGlzY29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLmRldmljZXMuZmluZEluZGV4KGQgPT4gZC5nZXRTb2NrZXQoKSA9PT0gc29ja2V0KTtcbiAgICB0aGlzLmRldmljZXMuc3BsaWNlKGZvdW5kLCAxKTtcbiAgfVxufVxuIl19