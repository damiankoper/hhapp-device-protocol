"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const socket_io_1 = __importDefault(require("socket.io"));
const DeviceControllerManaged_1 = __importDefault(require("./DeviceControllerManaged"));
const DeviceManaged_1 = __importDefault(require("./DeviceManaged"));
class Manager {
    constructor(config) {
        this.devices = [];
        this.controllers = [];
        this.statusHandlers = new Map();
        this.config = config;
        this.socket = socket_io_1.default();
        this.socket.listen(this.config.port);
        this.socket.on('connection', socket => {
            this.initConnectedDevice(socket);
        });
    }
    destroy() {
        this.socket.close();
    }
    getDevices() {
        return this.devices;
    }
    getControllers() {
        return this.controllers;
    }
    onConnection(fn) {
        this.onConnectionHandler = fn;
    }
    onStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.onStatus(fn);
        });
        this.statusHandlers.set(fn, target);
    }
    offStatus(target, fn) {
        this.findTargets(target).forEach(device => {
            device.offStatus(fn);
        });
        this.statusHandlers.delete(fn);
    }
    sendAction(actionConfig, payload) {
        const target = this.findTargets(actionConfig);
        if (target.length === 0) {
            throw new Error('Action ' + actionConfig.action + ' target not found!');
        }
        target.forEach((d) => {
            d.sendAction(actionConfig.action, payload);
        });
    }
    findTargets(targetConfig) {
        return this.devices.filter(d => d.matchesTarget(targetConfig));
    }
    findTargetControllers(targetConfig) {
        return this.controllers.filter(d => d.matchesTarget(targetConfig));
    }
    initConnectedDevice(socket) {
        if (socket.handshake.query.controller) {
            this.setController(socket);
        }
        else {
            this.setDevice(socket);
        }
    }
    destroyDisconnectedDevice(socket) {
        const found = this.devices.findIndex(d => d.getSocket() === socket);
        this.devices.splice(found, 1);
    }
    setDevice(socket) {
        const device = new DeviceManaged_1.default(Object.assign({}, socket.handshake.query, { socket }));
        this.devices.push(device);
        this.setStatusHandlers(device);
        socket.on('disconnect', () => this.destroyDisconnectedDevice(socket));
        if (this.onConnectionHandler) {
            this.onConnectionHandler(device);
        }
    }
    setController(socket) {
        this.controllers.push(new DeviceControllerManaged_1.default(Object.assign({}, socket.handshake.query, { socket }), this.devices));
    }
    setStatusHandlers(device) {
        this.statusHandlers.forEach((target, fn) => {
            if (device.matchesTarget(target)) {
                device.onStatus(fn);
            }
        });
        device.onStatus(status => {
            this.findTargetControllers(device.getTargetConfig()).forEach(controller => {
                controller.sendStatus(status);
            });
        });
    }
}
exports.Manager = Manager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9NYW5hZ2VyL01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBaUM7QUFJakMsd0ZBQWdFO0FBQ2hFLG9FQUE0QztBQXVCNUMsTUFBYSxPQUFPO0lBWWxCLFlBQVksTUFBcUI7UUFUekIsWUFBTyxHQUFvQixFQUFFLENBQUM7UUFDOUIsZ0JBQVcsR0FBOEIsRUFBRSxDQUFDO1FBRTVDLG1CQUFjLEdBR2xCLElBQUksR0FBRyxFQUFFLENBQUM7UUFJWixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFHLG1CQUFRLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVNLFVBQVU7UUFDZixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVNLGNBQWM7UUFDbkIsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzFCLENBQUM7SUFFTSxZQUFZLENBQUMsRUFBbUM7UUFDckQsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRU0sUUFBUSxDQUFDLE1BQW9CLEVBQUUsRUFBa0M7UUFDdEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7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QUksaUNBQXVCLG1CQUVwQixNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssSUFDekIsTUFBTSxLQUVSLElBQUksQ0FBQyxPQUFPLENBQ2IsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVPLGlCQUFpQixDQUFDLE1BQXFCO1FBQzdDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFO1lBQ3pDLElBQUksTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDaEMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNyQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN2QixJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUMxRCxVQUFVLENBQUMsRUFBRTtnQkFDWCxVQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUE3SEQsMEJBNkhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNvY2tldElPIGZyb20gJ3NvY2tldC5pbyc7XG5cbmltcG9ydCB7IERldmljZVNlcnZlckNvbmZpZyB9IGZyb20gJy4uL0RldmljZS9EZXZpY2UnO1xuaW1wb3J0IHsgRGV2aWNlU3RhdHVzIH0gZnJvbSAnLi4vRGV2aWNlL1N0YXR1cyc7XG5pbXBvcnQgRGV2aWNlQ29udHJvbGxlck1hbmFnZWQgZnJvbSAnLi9EZXZpY2VDb250cm9sbGVyTWFuYWdlZCc7XG5pbXBvcnQgRGV2aWNlTWFuYWdlZCBmcm9tICcuL0RldmljZU1hbmFnZWQnO1xuXG50eXBlIE1hY0FkZHJlc3MgPSBzdHJpbmc7XG50eXBlIERldmljZVR5cGUgPSBzdHJpbmc7XG50eXBlIEFjdGlvblR5cGUgPSBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFuYWdlckNvbmZpZyB7XG4gIHBvcnQ6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYXJnZXRDb25maWcge1xuICBuYW1lPzogTWFjQWRkcmVzcztcbiAgdHlwZT86IERldmljZVR5cGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uQ29uZmlnIGV4dGVuZHMgVGFyZ2V0Q29uZmlnIHtcbiAgYWN0aW9uOiBBY3Rpb25UeXBlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERldmljZVByb3h5Q29uZmlnIGV4dGVuZHMgVGFyZ2V0Q29uZmlnIHtcbiAgc2VydmVyczogRGV2aWNlU2VydmVyQ29uZmlnW107XG59XG5cbmV4cG9ydCBjbGFzcyBNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBjb25maWc6IE1hbmFnZXJDb25maWc7XG4gIHByaXZhdGUgc29ja2V0OiBTb2NrZXRJTy5TZXJ2ZXI7XG4gIHByaXZhdGUgZGV2aWNlczogRGV2aWNlTWFuYWdlZFtdID0gW107XG4gIHByaXZhdGUgY29udHJvbGxlcnM6IERldmljZUNvbnRyb2xsZXJNYW5hZ2VkW10gPSBbXTtcblxuICBwcml2YXRlIHN0YXR1c0hhbmRsZXJzOiBNYXA8XG4gICAgKHN0YXR1czogRGV2aWNlU3RhdHVzKSA9PiB2b2lkLFxuICAgIFRhcmdldENvbmZpZ1xuICA+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIG9uQ29ubmVjdGlvbkhhbmRsZXI/OiAoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogTWFuYWdlckNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuc29ja2V0ID0gU29ja2V0SU8oKTtcbiAgICB0aGlzLnNvY2tldC5saXN0ZW4odGhpcy5jb25maWcucG9ydCk7XG4gICAgdGhpcy5zb2NrZXQub24oJ2Nvbm5lY3Rpb24nLCBzb2NrZXQgPT4ge1xuICAgICAgdGhpcy5pbml0Q29ubmVjdGVkRGV2aWNlKHNvY2tldCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLnNvY2tldC5jbG9zZSgpO1xuICB9XG5cbiAgcHVibGljIGdldERldmljZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZGV2aWNlcztcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb250cm9sbGVycygpIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVycztcbiAgfVxuXG4gIHB1YmxpYyBvbkNvbm5lY3Rpb24oZm46IChkZXZpY2U6IERldmljZU1hbmFnZWQpID0+IHZvaWQpIHtcbiAgICB0aGlzLm9uQ29ubmVjdGlvbkhhbmRsZXIgPSBmbjtcbiAgfVxuXG4gIHB1YmxpYyBvblN0YXR1cyh0YXJnZXQ6IFRhcmdldENvbmZpZywgZm46IChzdGF0dXM6IERldmljZVN0YXR1cykgPT4gdm9pZCkge1xuICAgIHRoaXMuZmluZFRhcmdldHModGFyZ2V0KS5mb3JFYWNoKGRldmljZSA9PiB7XG4gICAgICBkZXZpY2Uub25TdGF0dXMoZm4pO1xuICAgIH0pO1xuICAgIHRoaXMuc3RhdHVzSGFuZGxlcnMuc2V0KGZuLCB0YXJnZXQpO1xuICB9XG5cbiAgcHVibGljIG9mZlN0YXR1cyh0YXJnZXQ6IFRhcmdldENvbmZpZywgZm46IChzdGF0dXM6IERldmljZVN0YXR1cykgPT4gdm9pZCkge1xuICAgIHRoaXMuZmluZFRhcmdldHModGFyZ2V0KS5mb3JFYWNoKGRldmljZSA9PiB7XG4gICAgICBkZXZpY2Uub2ZmU3RhdHVzKGZuKTtcbiAgICB9KTtcbiAgICB0aGlzLnN0YXR1c0hhbmRsZXJzLmRlbGV0ZShmbik7XG4gIH1cblxuICBwdWJsaWMgc2VuZEFjdGlvbihhY3Rpb25Db25maWc6IEFjdGlvbkNvbmZpZywgcGF5bG9hZDogb2JqZWN0KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5maW5kVGFyZ2V0cyhhY3Rpb25Db25maWcpO1xuICAgIGlmICh0YXJnZXQubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjdGlvbiAnICsgYWN0aW9uQ29uZmlnLmFjdGlvbiArICcgdGFyZ2V0IG5vdCBmb3VuZCEnKTtcbiAgICB9XG4gICAgdGFyZ2V0LmZvckVhY2goKGQ6IERldmljZU1hbmFnZWQpID0+IHtcbiAgICAgIGQuc2VuZEFjdGlvbihhY3Rpb25Db25maWcuYWN0aW9uLCBwYXlsb2FkKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFRhcmdldHModGFyZ2V0Q29uZmlnOiBUYXJnZXRDb25maWcpOiBEZXZpY2VNYW5hZ2VkW10ge1xuICAgIHJldHVybiB0aGlzLmRldmljZXMuZmlsdGVyKGQgPT4gZC5tYXRjaGVzVGFyZ2V0KHRhcmdldENvbmZpZykpO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kVGFyZ2V0Q29udHJvbGxlcnMoXG4gICAgdGFyZ2V0Q29uZmlnOiBUYXJnZXRDb25maWdcbiAgKTogRGV2aWNlQ29udHJvbGxlck1hbmFnZWRbXSB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbGxlcnMuZmlsdGVyKGQgPT4gZC5tYXRjaGVzVGFyZ2V0KHRhcmdldENvbmZpZykpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Q29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgaWYgKHNvY2tldC5oYW5kc2hha2UucXVlcnkuY29udHJvbGxlcikge1xuICAgICAgdGhpcy5zZXRDb250cm9sbGVyKHNvY2tldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0RGV2aWNlKHNvY2tldCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95RGlzY29ubmVjdGVkRGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLmRldmljZXMuZmluZEluZGV4KGQgPT4gZC5nZXRTb2NrZXQoKSA9PT0gc29ja2V0KTtcbiAgICB0aGlzLmRldmljZXMuc3BsaWNlKGZvdW5kLCAxKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RGV2aWNlKHNvY2tldDogU29ja2V0SU8uU29ja2V0KSB7XG4gICAgY29uc3QgZGV2aWNlID0gbmV3IERldmljZU1hbmFnZWQoe1xuICAgICAgLi4uc29ja2V0LmhhbmRzaGFrZS5xdWVyeSxcbiAgICAgIHNvY2tldCxcbiAgICB9KTtcbiAgICB0aGlzLmRldmljZXMucHVzaChkZXZpY2UpO1xuICAgIHRoaXMuc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlKTtcbiAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCAoKSA9PiB0aGlzLmRlc3Ryb3lEaXNjb25uZWN0ZWREZXZpY2Uoc29ja2V0KSk7XG5cbiAgICBpZiAodGhpcy5vbkNvbm5lY3Rpb25IYW5kbGVyKSB7XG4gICAgICB0aGlzLm9uQ29ubmVjdGlvbkhhbmRsZXIoZGV2aWNlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldENvbnRyb2xsZXIoc29ja2V0OiBTb2NrZXRJTy5Tb2NrZXQpIHtcbiAgICB0aGlzLmNvbnRyb2xsZXJzLnB1c2goXG4gICAgICBuZXcgRGV2aWNlQ29udHJvbGxlck1hbmFnZWQoXG4gICAgICAgIHtcbiAgICAgICAgICAuLi5zb2NrZXQuaGFuZHNoYWtlLnF1ZXJ5LFxuICAgICAgICAgIHNvY2tldCxcbiAgICAgICAgfSxcbiAgICAgICAgdGhpcy5kZXZpY2VzXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3RhdHVzSGFuZGxlcnMoZGV2aWNlOiBEZXZpY2VNYW5hZ2VkKSB7XG4gICAgdGhpcy5zdGF0dXNIYW5kbGVycy5mb3JFYWNoKCh0YXJnZXQsIGZuKSA9PiB7XG4gICAgICBpZiAoZGV2aWNlLm1hdGNoZXNUYXJnZXQodGFyZ2V0KSkge1xuICAgICAgICBkZXZpY2Uub25TdGF0dXMoZm4pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgZGV2aWNlLm9uU3RhdHVzKHN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmZpbmRUYXJnZXRDb250cm9sbGVycyhkZXZpY2UuZ2V0VGFyZ2V0Q29uZmlnKCkpLmZvckVhY2goXG4gICAgICAgIGNvbnRyb2xsZXIgPT4ge1xuICAgICAgICAgIGNvbnRyb2xsZXIuc2VuZFN0YXR1cyhzdGF0dXMpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG4iXX0=